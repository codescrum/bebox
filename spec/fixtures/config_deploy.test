require 'capistrano/ext/multistage'

set :application, "pname"
set :stages, ["vagrant", "production"]
set :default_stage, 'vagrant'
set :use_sudo, false
set(:apt_dependencies) { ["git-core", "build-essential", "curl"] }

namespace :deploy do

  desc 'Installs tools and required dependencies in the remote machine'
  namespace :prepare do

    desc 'Install dependencies and command line tools to operate correctly'
    task :default do
      ubuntu.setup
      dependencies
    end

    desc 'Install libraries'
    task :dependencies do
      run "#{sudo} aptitude update"
      run "#{sudo} aptitude -y install #{apt_dependencies.join(' ')}"
    end

    namespace :ubuntu do
      desc 'Install dependencies and command line tools to opperate correctly'
      task :setup do
        full_upgrade
        set_fqdn
      end

      desc 'Upgrade system'
      task :full_upgrade do
        run "#{sudo} apt-get update"
        run "#{sudo} apt-get -y install aptitude"
        run "#{sudo} aptitude -y full-upgrade"
      end

      desc "Sets the boxes' fully qualified domain name (fqdn), through the 'hostname' command"
      task :set_fqdn do
        run('hostname') do |ch, stream, out|
          if ch[:server].host.strip == out.strip
            puts "The #{ch[:server]} server hostname is configured properly"
          else
            run "#{sudo} hostname #{ch[:server].host}", hosts: ch[:server]
          end
        end
      end
    end
  end
end