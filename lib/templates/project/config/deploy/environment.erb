# Select options accord to the phase parameter
if phase == 'node_prepare'
  set :user, "root"
  set :ssh_key, '<%= "config/keys/environments/#{environment}/id_rsa" %>'
  set :copy_exclude, ['profiles', 'roles', 'steps']
  set(:deploy_to) { "/home/vagrant/code" }
  set(:deploy_via, :copy_subdir)
  set(:deploy_subdir, 'puppet')
else
  set :user, "puppet"
  set :ssh_key, '<%= "keys/puppet.rsa" %>'
  set :copy_exclude, [".git", ".gitignore", ".gitmodules", "*.box", "boxes", "keys"]
  set(:deploy_to) { "/home/puppet/puppet" }
  set(:deploy_via, :copy_subdir)
  set(:deploy_subdir, 'puppet')
end
# set :deploy_via, :copy
set :scm, :none
set :repository, "."


set :ssh_options, {
  :keys => ssh_key,
  :port => '22',
  :forward_agent => 'true'
}

# Start nodes definitions
<% if nodes.present? %>
<% nodes.each do |node| %>
  server "<%= node.hostname %>", :web, :app, :db
<% end %>
<% end %>
# End nodes definitions

desc 'Test the vagrant connection by doing issuing a simple echo command'
task :probe, roles: [:web, :app, :db] do
  run 'echo $PATH'
end